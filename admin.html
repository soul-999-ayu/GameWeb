<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Arcade - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxUmAfhmeqR0-rhD1U0YdlrhXCNE560O6x6N-C5Ve2suKq6wzk3OOhs2MaPI3B9qJqHDQ/exec';
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'primary-neon': '#4ade80', 'secondary-glow': '#00ffff', 'dark-bg': '#0f172a', 'card-bg': 'rgba(15, 23, 42, 0.9)' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: white; margin: 0; }
        
        /* Shared Background Layer */
        #background-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: url('resources/images/background/bg.png') no-repeat center center; background-size: cover;
            -webkit-backdrop-filter: blur(3px); backdrop-filter: blur(3px);
            background-color: rgba(0, 0, 0, 0.75); background-blend-mode: multiply;
        }
        
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .table-row:hover { background-color: rgba(255,255,255,0.05); }
    </style>
</head>
<body class="font-sans min-h-screen flex flex-col">

    <div id="background-layer"></div>

    <header class="flex justify-between items-center p-6 border-b border-gray-800 glass relative z-10">
        <h1 class="text-2xl font-bold text-primary-neon tracking-widest">ADMIN CONSOLE</h1>
        <button onclick="handleLogout()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-power-off"></i> Logout</button>
    </header>

    <!-- LOGIN OVERLAY -->
    <div id="login-view" class="fixed inset-0 flex items-center justify-center bg-black/90 z-50">
        <div class="glass p-8 rounded-xl w-96 text-center border border-secondary-glow/30">
            <h2 class="text-xl font-bold mb-6 text-secondary-glow">AUTHENTICATION</h2>
            <input type="password" id="admin-pass" placeholder="Enter Admin Key" class="w-full p-3 bg-black/50 border border-gray-600 rounded mb-4 text-white outline-none focus:border-secondary-glow transition">
            <button onclick="adminLogin()" class="w-full bg-secondary-glow text-dark-bg font-bold py-3 rounded hover:bg-white transition">ACCESS</button>
        </div>
    </div>

    <!-- MAIN CONTENT DASHBOARD -->
    <div id="dashboard-view" class="hidden flex-grow p-8 max-w-7xl mx-auto w-full relative z-0">
        
        <!-- NAV CARDS -->
        <div id="nav-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 mt-10">
            <!-- GAMES CARD -->
            <div onclick="loadTable('games')" class="glass p-8 rounded-xl cursor-pointer hover:border-primary-neon transition text-center group border-t-4 border-transparent hover:scale-[1.02]">
                <i class="fa-solid fa-gamepad text-5xl text-primary-neon mb-4"></i>
                <h3 class="text-xl font-bold">GAMES</h3>
                <p class="text-gray-400 text-sm mt-2">Manage game list and visibility</p>
            </div>
            <!-- SOCIALS CARD -->
            <div onclick="loadTable('socials')" class="glass p-8 rounded-xl cursor-pointer hover:border-secondary-glow transition text-center group border-t-4 border-transparent hover:scale-[1.02]">
                <i class="fa-solid fa-share-nodes text-5xl text-secondary-glow mb-4"></i>
                <h3 class="text-xl font-bold">SOCIALS</h3>
                <p class="text-gray-400 text-sm mt-2">Update social links and icons</p>
            </div>
            <!-- USERS CARD -->
            <div onclick="loadTable('users')" class="glass p-8 rounded-xl cursor-pointer hover:border-purple-500 transition text-center group border-t-4 border-transparent hover:scale-[1.02]">
                <i class="fa-solid fa-users text-5xl text-purple-500 mb-4"></i>
                <h3 class="text-xl font-bold">USERS</h3>
                <p class="text-gray-400 text-sm mt-2">View registered user accounts</p>
            </div>
        </div>

        <!-- TABLE VIEW -->
        <div id="table-area" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showNav()" class="text-gray-400 hover:text-white flex items-center gap-2 transition"><i class="fa-solid fa-arrow-left"></i> Back</button>
                <h2 id="table-title" class="text-2xl font-bold uppercase text-white">Data</h2>
                <button id="add-btn" onclick="openModal()" class="bg-primary-neon text-dark-bg px-4 py-2 rounded font-bold hover:bg-white transition"><i class="fa-solid fa-plus"></i> ADD NEW</button>
            </div>
            
            <div class="overflow-x-auto glass rounded-xl">
                <table class="w-full text-left text-sm text-gray-300">
                    <thead id="table-head" class="bg-black/40 text-secondary-glow uppercase font-bold"></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            <div id="loading" class="text-center py-8 hidden"><i class="fa-solid fa-circle-notch fa-spin text-4xl text-secondary-glow"></i></div>
        </div>
    </div>

    <!-- EDIT/ADD MODAL -->
    <div id="editor-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="glass p-8 rounded-xl w-full max-w-lg relative border border-gray-700">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fa-solid fa-times fa-lg"></i></button>
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-primary-neon">EDIT ITEM</h2>
            <form id="editor-form" class="space-y-4">
                <!-- Inputs injected via JS -->
            </form>
            <button onclick="saveChanges()" class="w-full bg-primary-neon text-dark-bg font-bold py-3 rounded mt-6 hover:bg-white transition">SAVE CHANGES</button>
        </div>
    </div>

    <script>
        let currentType = '', currentData = [], editingKey = null; 

        // AUTHENTICATION
        function adminLogin() {
            // Hardcoded password check
            if(document.getElementById('admin-pass').value === "GameWeb") { 
                sessionStorage.setItem('AdminAuth', 'true');
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
            } else alert("Invalid Password");
        }
        
        function handleLogout() { sessionStorage.removeItem('AdminAuth'); window.location.reload(); }

        // Check persistent login
        if(sessionStorage.getItem('AdminAuth') === 'true') {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
        }

        // NAVIGATION
        function showNav() { document.getElementById('table-area').classList.add('hidden'); document.getElementById('nav-cards').classList.remove('hidden'); }

        // LOAD DATA
        function loadTable(type) {
            currentType = type;
            document.getElementById('nav-cards').classList.add('hidden');
            document.getElementById('table-area').classList.remove('hidden');
            document.getElementById('table-title').textContent = type.toUpperCase();
            document.getElementById('table-body').innerHTML = '';
            document.getElementById('loading').classList.remove('hidden');
            
            // Hide Add button for Users table (users usually register themselves)
            document.getElementById('add-btn').style.display = (type === 'users') ? 'none' : 'block';

            fetch(API_URL, {
                method: 'POST',
                // 'action' tells the Apps Script router what to do
                body: JSON.stringify({ action: 'get_data', type: type })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                if(data.result === 'success') {
                    renderTable(data.message); // Apps Script returns data in 'message' property
                } else {
                    alert("Failed to load data: " + data.message);
                }
            })
            .catch(e => {
                console.error(e);
                alert("Connection failed.");
                document.getElementById('loading').classList.add('hidden');
            });
        }

        // RENDER TABLE
        function renderTable(rows) {
            currentData = rows;
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            
            // Row 0 is always headers
            let headHtml = '<tr>';
            rows[0].forEach(header => headHtml += `<th class="p-4 border-b border-gray-700">${header}</th>`);
            if(currentType !== 'users') headHtml += '<th class="p-4 border-b border-gray-700">ACTIONS</th>'; 
            headHtml += '</tr>';
            thead.innerHTML = headHtml;

            // Rows 1+ are data
            let bodyHtml = '';
            for(let i=1; i<rows.length; i++) {
                bodyHtml += `<tr class="table-row border-b border-gray-800 transition">`;
                rows[i].forEach(cell => {
                    let text = String(cell);
                    // Truncate long text for display (like long URLs)
                    if(text.length > 40) text = text.substring(0, 40) + '...';
                    bodyHtml += `<td class="p-4">${text}</td>`;
                });
                
                // Add Edit/Delete buttons for non-user tables
                if(currentType !== 'users') {
                    // Use the first column (Name/Platform) as the unique key
                    const key = rows[i][0]; 
                    bodyHtml += `
                        <td class="p-4 flex gap-3">
                            <button onclick="openModal('${key}')" class="text-blue-400 hover:text-white transition" title="Edit"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteItem('${key}')" class="text-red-500 hover:text-white transition" title="Delete"><i class="fa-solid fa-trash"></i></button>
                        </td>`;
                }
                bodyHtml += `</tr>`;
            }
            tbody.innerHTML = bodyHtml;
        }

        // MODAL LOGIC
        function openModal(key = null) {
            editingKey = key;
            const form = document.getElementById('editor-form');
            const headers = currentData[0];
            document.getElementById('modal-title').textContent = key ? "EDIT ITEM" : "ADD NEW ITEM";
            form.innerHTML = '';

            // If key exists, find the matching row to populate values
            let rowData = key ? currentData.find(row => row[0] === key) : null;

            headers.forEach((header, index) => {
                const val = rowData ? rowData[index] : '';
                form.innerHTML += `<div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">${header}</label>
                    <input type="text" id="input-${index}" value="${val}" class="w-full p-2 bg-black/40 border border-gray-600 rounded text-white text-sm focus:border-secondary-glow outline-none transition">
                </div>`;
            });
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('editor-modal').classList.add('hidden'); }

        // SAVE CHANGES (ADD OR UPDATE)
        function saveChanges() {
            const headers = currentData[0];
            const newData = [];
            // Collect all input values
            for(let i=0; i<headers.length; i++) newData.push(document.getElementById('input-'+i).value);

            const btn = document.querySelector('#editor-modal button:last-child');
            btn.textContent = "SAVING..."; btn.disabled = true;

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: editingKey ? 'update_row' : 'add_row', 
                    type: currentType, 
                    newData: newData, 
                    originalKey: editingKey 
                })
            })
            .then(res => res.json())
            .then(data => {
                btn.textContent = "SAVE CHANGES"; btn.disabled = false;
                if(data.result === 'success') { 
                    closeModal(); 
                    loadTable(currentType); // Refresh table to show changes
                } else {
                    alert("Error: " + data.message);
                }
            });
        }

        // DELETE ITEM
        function deleteItem(key) {
            if(!confirm("Are you sure you want to delete this item? This cannot be undone.")) return;
            
            fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'delete_row', type: currentType, key: key }) 
            })
            .then(res => res.json())
            .then(data => { 
                if(data.result === 'success') loadTable(currentType); 
                else alert("Error: " + data.message); 
            });
        }
    </script>
</body>
</html>